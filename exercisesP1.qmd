---
title: "EJERCICIOS P1"
date: today
date-format: "DD MMMM, YYYY"
author: 
  Mathias
abstract:
    Genetica de poblaciones
abstractspacing: double
appendix: false
fontfamily: libertine
monofont: inconsolata
monofontoptions: scaled=.95
fontsize: 12pt
geometry: 
  - top=2cm
  - bottom=2cm
  - left=2cm
  - right=2cm
urlcolor: darkblue
highlight-style: arrow
format: 
    pdf:
      toc: true
      number-sections: true
      colorlinks: true
---

# Total de ejercicios de genetica de poblaciones

1. Completar la siguiente tabla, en la que y son las frecuencias de un alelo de referencia en las
subpoblaciones 1 y 2, respectivamente:

| $p_1$ | $H_1$ | $p_2$ | $H_2$ | $\bar{H_s}$ | $\frac{(p_1-p_2)^2}{2}$ | $\bar{H_t}$ |
|-------|-------|-------|-------|-------------|-------------------------|-------------|
|  0.4  |       |  0.6  |       |             |                         |             |
|  0.1  |       |  0.3  |       |             |                         |             |
|  0 1  |       |       |       |             |                         |             |

¬øC√≥mo se comparan los dos primeros casos?

2. Ejemplo 2: Asignando genotipos a subpoblaciones con frecuencias al√©licas conocidas
Nos gustar√≠a asignar un individuo a una de dos posibles subpoblaciones fuente $S_1$ y $S_2$ seg√∫n su genotipo
$G_1 = a_1a_1b_1b_2c_1c_1 $, obtenido para tres loci bial√©licos no ligados. Se conocen las frecuencias al√©licas en
estas dos subpoblaciones:

Tabla 1. Frecuencias al√©licas en dos subpoblaciones

|          | $S_1$ | $S_2$ |
|----------|-------|-------|
| $f(a_1)$ |   0.3 |  0.2  |
| $f(b_1)$ |   0.2 |  0.25 |
| $f(c_1)$ |   0.3 |  0.2  |

¬øCu√°les son las probabilidades de observar este genotipo en particular en cada una de las dos
subpoblaciones? 

1. La frecuencia de un alelo autos√≥mico A en una poblaci√≥n es $p = 0.1$.
¬øCu√°l es el n√∫mero esperado de alelos A en una muestra de 20 alelos?
¬øCu√°l es la probabilidad de no observar el alelo A en la muestra?
2. Utilizando la funci√≥n rbinom, simule un gran n√∫mero de muestras de tama√±o $n = 20$ y
caracterice la distribuci√≥n de los resultados utilizando descriptores gr√°ficos y num√©ricos
apropiados.
3. Considere ahora el caso de $f(A) = p = 0.01$.¬øCu√°l es la probabilidad de observar el alelo
A en una muestra de $n = 20$?
4. La frecuencia observada de un alelo autos√≥mico diploide A es 3/10 (tama√±o de la
muestra $n = 10$). Utilice dbinom para calcular la probabilidad de observar esta frecuencia
en la muestra para un rango de frecuencias subyacentes en la poblaci√≥n entre $0,01$ y
$0,99$.
5. Genotipos como muestras aleatorias de tama√±o $n = 2$. Para un locus autos√≥mico
diploide con dos alelos, describa las proporciones de HW como esperanzas de la
distribuci√≥n binomial.
6. Para una muestra de $n = 10$ individuos, obtenga la frecuencia esperada de
heterocigotos para $f(A) = 0.3$ y utilice rbinom para simular un gran n√∫mero de muestras
y caracterizar la variaci√≥n aleatoria de la frecuencia observada de heterocigotos.
8. Para $n=4$, obtener en R una simulaci√≥n de todos los componentes del proceso
coalescente. Asumir que $N = 5\times 10^{5}$ y $\mu = 10-5$. Para la realizaci√≥n obtenida, calcular $\pi$, $S$
y $\theta_W$.
9. Structure:
El programa structure se corri√≥ con $K = 2$ y 90 genotipos, y la cadena de MCMC par√≥ en la
generaci√≥n $m-1$. Nos enfocamos en un s√≥lo locus con alelos.
El estado de la cadena en $m-1$ es el siguiente:
Frecuencias del alelo de referencia en cada subpoblaci√≥n:
$P(m-1)1 = 0.5$, $P(m-1)2 = 0.8$.
Ubicaci√≥n de los genotipos a subpoblaciones:

|      | Subpoblaci√≥n 1 | Subpoblaci√≥n 2 |
|------|----------------|----------------|
| $ùê¥ùê¥$ |      13        |      25        |
| $ùê¥ùëé$ |      24        |       13       |
| $ùëéùëé$  |      13        |      2         |
| Total |     50        |       40       |

a) Usando una distribuci√≥n apropiada, obtener valores propuestos de para la $P$
generaci√≥n $m[P(m)]$ para cada subpoblaci√≥n. Explicar, en cada caso, si deber√≠an ser 
aceptadas como los nuevos valores $P(m)_{1}$ y $P(m)_{2}$ y con qu√© regla de
probabilidad.
b) Ahora considerar un genotipo que puede moverse de la subpoblaci√≥n 1 a la 2.ùê¥ùëé
Explicar c√≥mo se toma la decisi√≥n de moverlo o no.
En las respuestas, incluir tanto las explicaciones como el c√≥digo de R o los c√°lculos
equivalentes.

# Ejercicio 1: Frecuencias en subpoblaciones, practico Efecto Wahalund

1. Completar la siguiente tabla, en la que y son las frecuencias de un alelo de referencia en las
subpoblaciones 1 y 2, respectivamente:

| $p_1$ | $H_1$ | $p_2$ | $H_2$ | $\bar{H_s}$ | $\frac{(p_1-p_2)^2}{2}$ | $\bar{H_t}$ |
|-------|-------|-------|-------|-------------|-------------------------|-------------|
|  0.4  |       |  0.6  |       |             |                         |             |
|  0.1  |       |  0.3  |       |             |                         |             |
|  0 1  |       |   1   |       |             |                         |             |

¬øC√≥mo se comparan los dos primeros casos?

$H_1$ y $H_2$ ‚Üí heterocigosidad esperada dentro de cada subpoblaci√≥n.

$\bar{H_s}$ ‚Üí heterocigosidad promedio dentro de subpoblaciones.

$\bar{H_t}$ ‚Üí heterocigosidad total si las subpoblaciones se trataran como una sola (poblaci√≥n combinada).

$\dfrac{(p_1 - p_2)^2}{2}$ ‚Üí exceso de varianza en frecuencias al√©licas entre subpoblaciones, que contribuye a la p√©rdida de heterocigotos al combinar poblaciones.

Para calcular $H$ usamos Hardy-Weinberg para heterosigotas
$H = 2 \cdot p \cdot (1-p)$
Para H1 $p=0.4$ $H=2\cdot0.4\cdot(1-0.4)$, para $p=0.1$ $H=2\cdot0.1\cdot(1-0.1)$, para $p=0$ $H=2\cdot0\cdot(1-0)$  
Para H2 $p=0.6$ $H=2\cdot0.6\cdot(1-0.6)$, para $p=0.3$ $H=2\cdot0.3\cdot(1-0.3)$, para $p=1$ $H=2\cdot1\cdot(1-1)$  

Para calcular $\bar{H_s}=p_1+p_2-p_1^2-p_2^2$ 
Para $\bar{H_s}$ $\bar{H_s}=0.4+0.6-0.4^2-0.6^2$, para Para $\bar{H_s}$ $\bar{H_s}=0.1+0.3-0.1^2-0.3^2$ y finalmente Para $\bar{H_s}$ $\bar{H_s}=0+1-0^2-1^2$

Para calcular el termino $\frac{(p_1-p_2)^2}{2}$ simplemente sustituimos

y finalmente usamos los terminos $\bar{H_s}$ y $\frac{(p_1-p_2)^2}{2}$ para calcular $\bar{H_t}$

| $p_1$ | $H_1$ | $p_2$ | $H_2$ | $\bar{H_s}$ | $\frac{(p_1-p_2)^2}{2}$ | $\bar{H_t}$ |
|-------|-------|-------|-------|-------------|-------------------------|-------------|
|  0.4  |  0.48 |  0.6  |  0.48 |     0.48    |          0.02           |    0.50     |
|  0.1  |  0.18 |  0.3  |  0.42 |     0.30    |          0.02           |    0.32     |
|  0 1  |   0   |   1   |    0  |       0     |          0.50           |    0.50     |

En el primer caso ($p_1=0.4$, $p_2=0.6$), la heterocigosidad dentro de cada subpoblaci√≥n es relativamente alta ($H_1 = H_2 = 0.48$). Al promediarlas, $\bar{H_s} = 0.48$. Pero cuando juntamos ambas subpoblaciones, la heterocigosidad total es un poco mayor ($\bar{H_t} = 0.50$). La diferencia es peque√±a, porque las frecuencias al√©licas no difieren demasiado.

En el segundo caso ($p_1=0.1$, $p_2=0.3$), las subpoblaciones est√°n m√°s diferenciadas: $\bar{H_s} = 0.30$, pero la heterocigosidad total sube a $0.32$. La diferencia es otra vez peque√±a, pero se ve m√°s clara la contribuci√≥n de la varianza de frecuencias ($0.02$).

En el tercer caso ($p_1=0$, $p_2=1$), cada subpoblaci√≥n es completamente homocig√≥tica ($H_1 = H_2 = 0$), pero al combinar ambas el total tiene la m√°xima heterocigosidad posible ($\bar{H_t} = 0.50$). Este es el ejemplo extremo del **efecto Wahlund**: dentro de cada subpoblaci√≥n no hay heterocigotos, pero si juntamos los datos parecer√≠a que la poblaci√≥n combinada deber√≠a tener un 50% de heterocigotos.

¬øC√≥mo se comparan los dos primeros casos?

Caso 1 ‚Üí m√°s heterocigotos porque $p$ est√° cerca de 0.5.

Caso 2 ‚Üí menos heterocigotos porque $p$ est√° m√°s lejos de 0.5.

Aunque las heterocigosidades absolutas difieren entre los dos casos, el **d√©ficit de heterocigotos** al combinar subpoblaciones es el mismo. Esto se debe a que el **efecto Wahlund depende √∫nicamente de la varianza en frecuencias al√©licas entre subpoblaciones**. En ambos casos, esa varianza produce el mismo t√©rmino.

$\frac{(p_1 - p_2)^2}{2}$

# Ejercicio 2: Asignando genotipos a subpoblaciones con frecuencias al√©licas conocidas 

2. Ejemplo 2: Asignando genotipos a subpoblaciones con frecuencias al√©licas conocidas
Nos gustar√≠a asignar un individuo a una de dos posibles subpoblaciones fuente $S_1$ y $S_2$ seg√∫n su genotipo
$G_1 = a_1a_1b_1b_2c_1c_1 $, obtenido para tres loci bial√©licos no ligados. Se conocen las frecuencias al√©licas en
estas dos subpoblaciones:

Tabla 1. Frecuencias al√©licas en dos subpoblaciones

|          | $S_1$ | $S_2$ |
|----------|-------|-------|
| $f(a_1)$ |   0.3 |  0.2  |
| $f(b_1)$ |   0.2 |  0.25 |
| $f(c_1)$ |   0.3 |  0.2  |

¬øCu√°les son las probabilidades de observar este genotipo en particular en cada una de las dos
subpoblaciones? 

Modelo de probabilidades de genotipos

Bajo equilibrio de Hardy‚ÄìWeinberg, la probabilidad de un genotipo depende de la frecuencia del alelo $p$:

Homocigota ($AA$): $p^2$

Heterocigota ($Aa$): $2p(1-p)$

Homocigota alternativo ($aa$): $(1-p)^2$

Dado que los loci son independientes, la probabilidad total del genotipo en una subpoblaci√≥n es el producto de las probabilidades en cada locus.

$L_1=P(AA|S_1)\cdot P(Aa|S_1)\cdot P(AA|S_1) \simeq P^2 \cdot 2\cdot P\cdot (1-P) \cdot P^2$

Probabilidad en $S_1$

Subpoblacion 1

$Locus1= P(a_1a_1|S_1) = P^2 = 0.3^2$

$Locus2= P(b_1b_2|S_1) = 2\cdot P\cdot (1-P) =  2\cdot 0.2\cdot (1-0.2)$ 

$Locus3= P(c_1c_1|S_1) = P^2 = 0.3^2$ 

$L_1= 0.3^2 \cdot 2\cdot 0.2\cdot (1-0.2) \cdot 0.3^2 = 0.002592$

Probabilidad en $S_2$

Subpoblacion 2

$Locus1= P(a_1a_1|S_2) = P^2 = 0.2^2$ 

$Locus2= P(b_1b_2|S_2) + 2\cdot P\cdot (1-P) =  2\cdot 0.25\cdot (1-0.25)$ 

$Locus3= P(c_1c_1|S_1) = P^2 = 0.2^2$ 

$L_2= 0.2^2 \cdot 2\cdot 0.25\cdot (1-0.25) \cdot 0.2^2 = 0.0006$

Razon de verosimilitud 

Comparamos qu√© subpoblaci√≥n explica mejor el genotipo:

$\frac{L1}{L2} = \frac{0.002592}{0.0006} = 4.32$ es 4.32 veces mas probable la subpoblacion 1 que la 2

El genotipo observado es 4.32 veces m√°s probable en $S_1$ que en $S_2$.

Probabilidad posteriori (Formula de Bayes)

Si asumimos probabilidades a priori iguales (es decir, que antes de ver el genotipo ambos or√≠genes son igualmente probables), la probabilidad de que el individuo pertenezca a $S_1$ dado su genotipo es:

$P(S_1 | G_1) = \frac{L_1}{L_1 + L_2} = \frac{0.002592}{0.002592 + 0.0006} = 0.812$

Con la informaci√≥n gen√©tica disponible, el individuo tiene un 81.2% de probabilidad de pertenecer a $S_1$.

# Ejercicio 1: Frecuencia de alelo p=0.1

1. La frecuencia de un alelo autos√≥mico A en una poblaci√≥n es $p = 0.1$.
¬øCu√°l es el n√∫mero esperado de alelos A en una muestra de 20 alelos?
¬øCu√°l es la probabilidad de no observar el alelo A en la muestra?

Para responder a estas preguntas, tratamos la extracci√≥n de cada alelo como un ensayo de Bernoulli, donde "√©xito" es obtener el alelo A.

- ¬øCu√°l es el n√∫mero esperado de alelos A en una muestra de 20 alelos?
La esperanza de una distribuci√≥n binomial se calcula como $E(X)=n‚ãÖp$. En este caso, el tama√±o de la muestra (n) es 20 y la frecuencia al√©lica (p) es 0.1.
    $E(X)=20‚ãÖ0.1=2$
Se espera que, en promedio, haya 2 alelos A en una muestra de 20.

- ¬øCu√°l es la probabilidad de no observar el alelo A en la muestra?
Aqu√≠ buscamos la probabilidad de obtener 0 √©xitos (k=0) en 20 ensayos. Usamos la f√≥rmula de la funci√≥n de la probabilidad binomial: $P(X=k)=\binom{n}{k} p^k‚ãÖ(1‚àíp)^{n‚àík}$.
    $P(X = 0) = \binom{20}{0} (0.1)^0‚ãÖ(1‚àí0.1)^20 = 1‚ãÖ1‚ãÖ(0.9)^20 \simeq 0.1216$.
    Hay un $12.16\%$ de probabilidad de no encontrar ning√∫n alelo A en la muestra.

# Ejercicio 2: Simulaci√≥n con rbinom

2. Utilizando la funci√≥n rbinom, simule un gran n√∫mero de muestras de tama√±o $n = 20$ y
caracterice la distribuci√≥n de los resultados utilizando descriptores gr√°ficos y num√©ricos
apropiados.

El objetivo de este ejercicio es simular el proceso de muestreo miles de veces para ver c√≥mo los resultados se distribuyen alrededor del valor esperado. rbinom en R genera n√∫meros aleatorios basados en una distribuci√≥n binomial.

- rbinom simula el n√∫mero de alelos A en muestras de tama√±o fijo.

- Esperamos ver que la media $\simeq 2$ y la desviaci√≥n est√°ndar $\simeq 1.34$.

- El histograma muestra que la mayor√≠a de las muestras tienen entre 0 y 5 alelos A, con el 2 como valor m√°s probable.

```{r}

# Definir los par√°metros
n <- 20  # Tama√±o de la muestra
p <- 0.1  # Frecuencia del alelo A

# Simular 10,000 muestras
num_simulaciones <- 10000
muestras_simuladas <- rbinom(n = num_simulaciones, size = n, prob = p)

# Descriptores num√©ricos
media_simulada <- mean(muestras_simuladas)
print(paste("La media de las simulaciones es:", round(media_simulada, 2)))
print(paste("La desviaci√≥n est√°ndar de las simulaciones es:", round(sd(muestras_simuladas), 2)))

# Gr√°fico de la distribuci√≥n
hist(muestras_simuladas,
     breaks = seq(-0.5, n + 0.5, by = 1),
     col = "skyblue",
     border = "white",
     main = "Distribuci√≥n de alelos A en 10,000 muestras",
     xlab = "N√∫mero de alelos A",
     ylab = "Frecuencia")
```

# Ejercicio 3: Frecuencia de alelo p=0.01

3. Considere ahora el caso de $f(A) = p = 0.01$.¬øCu√°l es la probabilidad de observar el alelo
A en una muestra de $n = 20$?

Para encontrar la probabilidad de observar el alelo A, es m√°s f√°cil calcular la probabilidad de no observarlo (0 alelos) y restarla de 1. ¬øCu√°l es la probabilidad de que, en esas 20 copias, aparezca al menos una vez el alelo A?.

$P(observar A)=1‚àíP(no observar A)$
$P(X \geq 1) = 1‚àíP(X=0) = 1 ‚àí \binom{20}{0}(0.01)^0‚ãÖ(0.99)^20= 1 ‚àí (0.99)^20 \simeq 1‚àí0.8179 = 0.1821$.
La probabilidad de observar al menos un alelo A es de aproximadamente 18.21%.

# Ejercicio 4: Frecuencia observada de 3/10

4. La frecuencia observada de un alelo autos√≥mico diploide A es 3/10 (tama√±o de la
muestra $n = 10$). Utilice dbinom para calcular la probabilidad de observar esta frecuencia
en la muestra para un rango de frecuencias subyacentes en la poblaci√≥n entre $0,01$ y
$0,99$.

Aqu√≠ invertimos el problema: tenemos la muestra y queremos saber qu√© tan probable es esta observaci√≥n para diferentes frecuencias poblacionales. Usamos dbinom, que calcula la probabilidad de un n√∫mero espec√≠fico de √©xitos.

Tenemos una muestra de 10 copias de un gen, y en ellas observamos que 3 son del alelo A.
La pregunta es: ¬øqu√© tan probable es esta observaci√≥n (3 de 10) si asumimos distintas frecuencias del alelo en la poblaci√≥n?

La distribuci√≥n binomial nos dice cu√°l es la probabilidad de observar un n√∫mero exacto de ‚Äú√©xitos‚Äù (en este caso, alelos A) en un n√∫mero fijo de ensayos (10 copias).

La funci√≥n dbinom(k, n, p)

```{r}
# Definir los par√°metros de la muestra
k_observado <- 3
n_muestra <- 10

# Rango de frecuencias poblacionales para evaluar
frecuencias_poblacionales <- seq(0.01, 0.99, by = 0.01) # Esto permite que recorra el vector cada 0.01

# Calcular la probabilidad para cada frecuencia poblacional
probabilidades <- dbinom(x = k_observado, size = n_muestra, prob = frecuencias_poblacionales)

# Gr√°fico de la verosimilitud
plot(frecuencias_poblacionales,
     probabilidades,
     type = "l",
     lwd = 2,
     col = "darkgreen",
     main = "Probabilidad de observar 3/10 alelos A",
     xlab = "Frecuencia poblacional hipot√©tica (p)",
     ylab = "Probabilidad de la muestra observada")

# Marcar el punto de m√°xima probabilidad
max_p <- frecuencias_poblacionales[which.max(probabilidades)]
points(max_p, max(probabilidades), col = "red", pch = 19)
text(max_p, max(probabilidades), labels = paste("p =", round(max_p, 2)), pos = 4, col = "red")
```

La curva muestra c√≥mo cambia esa probabilidad cuando vamos variando $p$. La curva tiene un pico en 
$p=0.3$, porque justamente $3/10 = 0.3$.

Lo que est√°s dibujando es la funci√≥n de verosimilitud de una binomial:

$L(p)=P(X=k‚à£n,p)= \binom{n}{k} p^k(1‚àíp)^{n‚àík}$ con $k=3$ y $n=10$.

El valor de $p$ que maximiza esta funci√≥n se llama estimador de m√°xima verosimilitud (MLE).

Si derivamos respecto a $p$:
$\frac{d}{dp}[p^k(1‚àíp)n‚àík]=0$ el resultado es $\hat{p}=k/n$ En este caso seria $\hat{p}=3/10$ Esto significa que, si tu muestra observada son 3 √©xitos en 10 intentos, el valor de $p$ que hace esa observaci√≥n m√°s probable es exactamente la frecuencia muestral (la proporci√≥n observada).


# Ejercicio 5: Proporciones de Hardy-Weinberg (HW)

5. Genotipos como muestras aleatorias de tama√±o $n = 2$. Para un locus autos√≥mico
diploide con dos alelos, describa las proporciones de HW como esperanzas de la
distribuci√≥n binomial.

Las proporciones de Hardy-Weinberg describen la distribuci√≥n de genotipos en una poblaci√≥n en equilibrio. Podemos ver la formaci√≥n de un genotipo como el resultado de tomar una muestra de 2 alelos, uno de cada padre.

Genotipo homocigoto dominante (AA): Para obtener este genotipo, ambos alelos deben ser A. La probabilidad de que esto ocurra es la de obtener 2 √©xitos $(k=2)$ en 2 ensayos, lo que es igual a $p^2$.
    $P(X=2)=\binom{2}{2}‚ãÖp^2‚ãÖ(1‚àíp)0=p^2.$ siendo que $\binom{2}{2} =  \frac{2!}{2!(2-2)!} = 1$

Genotipo heterocigoto (Aa): Para obtener este genotipo, necesitamos 1 alelo A y 1 alelo a. La probabilidad de obtener 1 √©xito (k=1) en 2 ensayos es $2p(1‚àíp)$.
    $P(X=1)=\binom{2}{1}‚ãÖp^1‚ãÖ(1‚àíp)^1 = 2p(1‚àíp)$. siendo que $\binom{2}{1} =  \frac{2!}{1!(2-1)!} = \frac{2}{1} = 2$

Las proporciones de HW $(p2, 2pq, q2)$ son, de hecho, las esperanzas de una distribuci√≥n binomial con n=2 ensayos, modelando la selecci√≥n aleatoria de alelos para formar un genotipo.

# Ejercicio 6: Frecuencia esperada de heterocigotos

Primero calculamos la frecuencia esperada de heterocigotos en la poblaci√≥n usando las proporciones de HW, y luego usamos rbinom para simular su variaci√≥n en muestras.

    Frecuencia esperada de heterocigotos:
    Si la frecuencia de un alelo es p=0.3, la frecuencia de heterocigotos en la poblaci√≥n es 2p(1‚àíp)=2‚ãÖ0.3‚ãÖ(1‚àí0.3)=0.42. En una muestra de 10 individuos, el n√∫mero esperado de heterocigotos es 10‚ãÖ0.42=4.2.

    Simulaci√≥n de la variaci√≥n:
    El tama√±o de la muestra es de 10 individuos, y la probabilidad de que un individuo sea heterocigoto es 0.42. Usamos rbinom para simular esto.

```{r}
# Definir los par√°metros
p_alelo_A <- 0.3
prob_heterocigoto <- 2 * p_alelo_A * (1 - p_alelo_A)
n_individuos <- 10

# Simular la variaci√≥n de la frecuencia de heterocigotos
num_simulaciones <- 10000
muestras_heterocigotos <- rbinom(n = num_simulaciones, size = n_individuos, prob = prob_heterocigoto)

# Caracterizar la distribuci√≥n
media_simulada_h <- mean(muestras_heterocigotos)
print(paste("La media de heterocigotos simulados es:", round(media_simulada_h, 2)))
print(paste("La desviaci√≥n est√°ndar de las simulaciones es:", round(sd(muestras_heterocigotos), 2)))

# Gr√°fico de la distribuci√≥n
hist(muestras_heterocigotos,
     breaks = seq(-0.5, n_individuos + 0.5, by = 1),
     col = "lightcoral",
     border = "white",
     main = "Distribuci√≥n de heterocigotos en 10,000 muestras",
     xlab = "N√∫mero de heterocigotos",
     ylab = "Frecuencia")
```

# Ejercicio 8: Simulaci√≥n del proceso coalescente con n=4

8. Para $n=4$, obtener en R una simulaci√≥n de todos los componentes del proceso
coalescente. Asumir que $N = 5\times 10^{5}$ y $\mu = 10-5$. Para la realizaci√≥n obtenida, calcular $\pi$, $S$
y $\theta_W$.

Queremos simular el coalescente para n=4 alelos, con:

Tama√±o efectivo de la poblaci√≥n $N=5 \times 10^5$

Tasa de mutaci√≥n $\mu=10^‚àí5$

Y a partir de esa genealog√≠a calcular:

$\pi$ (diversidad nucleot√≠dica promedio por par)

$S$ (n√∫mero de sitios segregantes)

$\theta_w$ (estimador de Watterson).

1. Para $n=4$ existen dos topologias posibles que tienen sus probabilidades asociadas. Estas topologias se forman con la siguiente distribucion de alelos (2,2) con probabilidad $1/3$ y la distribucion (3,1) con la probabilidad de $2/3$. Esta ultima distribucion puede tener la bifurcacion mas reciente en uno de los ancestros hermanos por eso su probabilidad es de $2/3$. Para simular este proceso usaremos la funcion de R runif (random uniforme), esta funcion nos proporciona un muestreo de un numero al azar entre 0 y 1.

```{r}

runif(1)

```

Si $runif > 0.33333$ nos quedamos con la topologia mas probable, si $runif \leq 0.33333$ nos quedamos con la manos probable de las topologias.

2. Los tiempos de coalescencia

Imaginemos que empezamos con $n=4$ linajes.
El proceso coalescente consiste en ver cu√°nto tardan en irse uniendo hasta llegar a un ancestro com√∫n.

La probabilidad de coalescencia por generaci√≥n depende de:

El n√∫mero de pares posibles: $\binom{n}{2}=\frac{n!}{2!(n-2)!}=n(n‚àí1)/2$
Y de $1/(2N)$, que es la probabilidad de que un par coalesca en una generaci√≥n.
El tiempo de espera hasta el evento coalescente es el inverso de esa probabilidad.

- De 4 a 3 linajes:
    Pares posibles: $C(4,2)=6$ usando el coficiente binomial $\binom{4}{2} = \frac{4!}{2!(4-2)!}$
    Probabilidad por generaci√≥n: $\binom{4}{2}.\frac{1}{2N} = 6/(2N)$
    Tiempo esperado: $E[T_4]=2N/6=10^6/6‚âà1.67√ó10^5$

- De 3 a 2 linajes:
    Pares posibles: $C(3,2)=3$ usando el coficiente binomial $\binom{3}{2} = \frac{3!}{2!(3-2)!}$
    Probabilidad por generaci√≥n: $\binom{3}{2}.\frac{1}{2N} = 3/(2N)$
    Tiempo esperado: $E[T_3]=2N/3‚âà3.33√ó10^5$

- De 2 a 1 linajes (MRCA):
    Pares posibles: $C(2,2)=1$ usando el coficiente binomial $\binom{2}{2} = \frac{2!}{2!(2-2)!}$
    Probabilidad por generaci√≥n: $\binom{2}{2}.\frac{1}{2N} = 1/(2N)$
    Tiempo esperado:  $E[T_2]=2N=10^6$

Entonces los tiempos de espera esperados son:

$T_4‚âà1.67√ó10^5$
$T_3‚âà3.33√ó10^5$
$T_2=10^6$

3. Tiempo total de ramas del √°rbol

Cada intervalo de tiempo tiene un cierto n√∫mero de linajes que lo ‚Äúrecorren‚Äù: $Ttotal=(n_1‚ãÖT_4)+(n_2‚ãÖT_3)+(n_3‚ãÖT_2)$

- Con 4 linajes durante $T_4$ : $4 \cdot 1.67 \times 10^5‚âà6.68 \times 10^5$

- Con 3 linajes durante $T_3$ : $3 \cdot 3.33 \times 10^5‚âà9.99 \times 10^5$

- Con 2 linajes durante $T_2$ : $2 \cdot 10^6=2 \times 10^6$

Sumando: $Ttotal‚âà3.67 \times 10^6$

4. N√∫mero de sitios segregantes $(S)$

El n√∫mero de sitios segregantes es simplemente: $S=Ttotal \cdot \mu$ 

$S‚âà(3.67 \times 10^6) \cdot (10^‚àí5)‚âà36.7$ mutaciones (sitios segregantes)

5. C√°lculo de $\pi$ (diversidad nucleot√≠dica promedio por par)

$\pi$ mide las diferencias promedio entre pares de secuencias.

En el coalescente, la esperanza de $\pi$ es: $\pi =4N\mu$

Con nuestros valores: $\pi=4‚ãÖ(5 \times 10^5)‚ãÖ10^‚àí5=20$

En la pr√°ctica, $\pi$ depender√° de c√≥mo se reparten las 37 mutaciones (sitios segregantes) en el √°rbol, pero el valor esperado es $\pi ‚âà 20$.

Si muchas mutaciones cayeron en ramas profundas (compartidas por muchos individuos), eso har√° que muchos pares de secuencias difieran en esas posiciones $\pi$ ser√° grande. Si la mayor√≠a de las mutaciones cayeron en ramas terminales (propias de un solo individuo), entonces solo unos pocos pares mostrar√°n esas diferencias $\pi$ ser√° m√°s chico.

6. C√°lculo de $\theta_W$ (Theta de Watterson)

Se define como: $\theta_W = \frac{S}{a_n}$ donde $a_n = \sum_{i=1}^{n-1}1/i$ entonces $\theta_W = \frac{S}{\sum_{i=1}^{n-1}1/i}$

Para $n=4$: $a_4=1+1/2+1/3‚âà1.833$

Entonces: $\theta_W=37/1.833‚âà20.18$

Resultado final

$S=37$

$\pi‚âà20$

$\theta_W‚âà20.18$

```{r}

# -----------------------------
# Par√°metros
# -----------------------------
N <- 5e5        # tama√±o efectivo
mu <- 1e-5      # tasa de mutaci√≥n
n <- 4          # n√∫mero de secuencias

# -----------------------------
# 1. Simular tiempos de coalescencia
# -----------------------------
# Funci√≥n para simular tiempo de espera (geom√©trico)
simular_T <- function(n_linajes, N) {
  pares <- choose(n_linajes, 2)
  p <- pares / (2 * N)     # probabilidad de coalescencia por generaci√≥n
  rgeom(1, p)              # tiempo de espera ~ geom√©trica
}

# Guardamos los tiempos
T4 <- simular_T(4, N)
T3 <- simular_T(3, N)
T2 <- simular_T(2, N)

cat("T4 =", T4, "\n")
cat("T3 =", T3, "\n")
cat("T2 =", T2, "\n")

# -----------------------------
# 2. Tiempo total de ramas
# -----------------------------
T_total <- (4 * T4) + (3 * T3) + (2 * T2)
cat("Tiempo total de ramas =", T_total, "\n")

# -----------------------------
# 3. N√∫mero de mutaciones (S)
# -----------------------------
S <- rpois(1, lambda = T_total * mu)  # Poisson con media T_total * mu
cat("N√∫mero de mutaciones S =", S, "\n")

# -----------------------------
# 4. Diversidad nucleot√≠dica (œÄ)
# -----------------------------
pi_est <- 4 * N * mu
cat("œÄ esperado =", pi_est, "\n")

# -----------------------------
# 5. Theta de Watterson (Œ∏W)
# -----------------------------
a_n <- sum(1 / (1:(n - 1)))
theta_W <- S / a_n
cat("Œ∏W estimado =", theta_W, "\n")


```

# Ejercicio 9: Sobre el algoritmo MCMC (Markov chain Monte Carlo)
9. Structure:
El programa structure se corri√≥ con $K = 2$ y 90 genotipos, y la cadena de MCMC par√≥ en la
generaci√≥n $m-1$. Nos enfocamos en un s√≥lo locus con alelos.
El estado de la cadena en $m-1$ es el siguiente:
Frecuencias del alelo de referencia en cada subpoblaci√≥n:
$P(m-1)1 = 0.5$, $P(m-1)2 = 0.8$.
Ubicaci√≥n de los genotipos a subpoblaciones:

|      | Subpoblaci√≥n 1 | Subpoblaci√≥n 2 |
|------|----------------|----------------|
| $ùê¥ùê¥$ |      13        |      25        |
| $ùê¥ùëé$ |      24        |       13       |
| $ùëéùëé$  |      13        |      2         |
| Total |     50        |       40       |

a) Usando una distribuci√≥n apropiada, obtener valores propuestos de para la $P$
generaci√≥n $m[P(m)]$ para cada subpoblaci√≥n. Explicar, en cada caso, si deber√≠an ser 
aceptadas como los nuevos valores $P(m)_{1}$ y $P(m)_{2}$ y con qu√© regla de
probabilidad.
b) Ahora considerar un genotipo que puede moverse de la subpoblaci√≥n 1 a la 2.ùê¥ùëé
Explicar c√≥mo se toma la decisi√≥n de moverlo o no.
En las respuestas, incluir tanto las explicaciones como el c√≥digo de R o los c√°lculos
equivalentes.

Idea general de los pasos qu√© hay que hacer

Est√°s en una iteraci√≥n del MCMC. Para cada subpoblaci√≥n:

1. Propon√©s un nuevo valor de frecuencia al√©lica $p\prime$ (por ejemplo: $p\prime \sim U(0,1)$)

2. Calcul√°s la verosimilitud de los datos (los genotipos observados en esa subpoblaci√≥n) con $p\prime$ propuesto y con el $p$ actual.

3. Acept√°s $p\prime$ como nuevo $p$ con probabilidad
$\alpha = \frac{p\prime}{p}$


a) Obtener y decidir sobre las nuevas frecuencias al√©licas

El objetivo aqu√≠ es simular el Paso 1 del algoritmo MCMC, donde se actualizan las frecuencias al√©licas de cada subpoblaci√≥n.

C√°lculo de Verosimilitud

La verosimilitud de los genotipos bajo una frecuencia al√©lica $p$ puede escribirse de dos formas equivalentes:

1. Como producto de probabilidades de genotipos (modelo de Hardy‚ÄìWeinberg).

$L(p) \propto [p^2]^{n_{\mathrm{AA}}} \cdot [2p(1-p)]^{n_{\mathrm{Aa}}} \cdot [(1-p)^2]^{n_{\mathrm{aa}}}$‚Äã

2. Como probabilidad binomial de observar $k$ alelos $A$ en $2n$ intentos, dado $p$.

Como la probabilidad binomial la subpoblaci√≥n hay $n$ individuos ($= 2n$ alelos), y observaste $k$ alelos $A$, la probabilidad de ver $k$ √©xitos bajo $p$ es

$Pr‚Å°(K=k‚à£p)=(\binom{2n}{k}p^k(1‚àíp)^{2n‚àík}$

En **R** eso se calcula con **dbinom(k, size=2*n, prob=p)**.

**Subpoblaci√≥n 1**

Datos de la **subpoblacion 1**: Frecuencia $P1‚Äã=0.5$, Genotipos: 13 AA, 24 Aa, 13 aa, $N=50$, $2N=100$

a mano la ecuacion seria $L(p)=Pr‚Å°(datos‚à£p)=\binom{(2\cdot50)}{50}0.5^50(1‚àí0.5)^{(2\cdot50)‚àí50}$
el propuesto $L(p\prime)=Pr‚Å°(datos‚à£p\prime)=\binom{(2\cdot50)}{50}p\prime^50(1‚àíp\prime)^{(2\cdot50)‚àí50}$

Numero de alelos $A:k = 2.13 + 24 = 50$

Recordemos:

Cada individuo tiene 2 alelos (porque estamos en organismos diploides).
Un AA aporta 2 copias del alelo A. Entonces $A=2 \times 13$

Un Aa aporta 1 copia de A y 1 de a. Entonces $A=1 \times 24$

Un aa aporta 0 copias de A. Entonces $A=0 \times 13$

En **Metropolis-Hastings**:

Si $\alpha \geq 1$, acept√°s siempre.
Si $\alpha < 1$, acept√°s con probabilidad $\alpha$. 

Si $u < \alpha$, acept√°s.
Si $u \geq \alpha$, rechaz√°s.

En este caso, $\alpha$ compara qu√© tan probable es observar los datos con la frecuencia propuesta $p'$ respecto de la frecuencia actual $p$. Si $\alpha$ es grande ($\geq 1$), significa que $p'$ explica igual o mejor los datos y se acepta siempre. Si $\alpha < 1$, se acepta con probabilidad proporcional a esa raz√≥n de verosimilitudes.

```{r}
p1 <- 0.5 # La frecuencia actual
p2 <- runif(1)
p2 # La frecuencia propuesta

# Verosimilitud bajo p1
conteo_p1 <- dbinom(50, 100, p1)
conteo_p1
# Verosimilitud bajo p2
conteo_p2 <- dbinom(50, 100, p2)
conteo_p2


# Raz√≥n de verosimilitudes (alpha)
alpha = conteo_p2/conteo_p1
alpha

# Decisi√≥n de aceptar o rechazar
u <- runif(1)
if (u < alpha) {
  decision <- "ACEPTAR"
} else {
  decision <- "RECHAZAR"
}
decision

```

Como la probabilidad binomial la subpoblaci√≥n hay $n$ individuos ($= 2n$ alelos), y observaste $k$ alelos $A$, la probabilidad de ver $k$ √©xitos bajo $p$ es

$L(p)=Pr‚Å°(K=k‚à£p)=(\binom{2n}{k}p^k(1‚àíp)^{2n‚àík}$

**Subpoblaci√≥n 2**

Datos de la **subpoblacion 2**: Frecuencia $P1‚Äã=0.8$, Genotipos: 25 AA, 13 Aa, 2 aa, $N=40$, $2N=80$

En **R** eso se calcula con **dbinom(k, size=2*n, prob=p)**.

a mano la ecuacion seria $L(p)=Pr‚Å°(datos‚à£p)=\binom{(2\cdot63)}{63}0.8^63(1‚àí0.8)^{(2\cdot63)‚àí63}$
el propuesto $L(p\prime)=Pr‚Å°(datos‚à£p\prime)=\binom{(2\cdot63)}{63}p\prime^63(1‚àíp\prime)^{(2\cdot63)‚àí63}$

Numero de alelos $A:k = 2.25 + 13 = 63$

Recordemos:

Cada individuo tiene 2 alelos (porque estamos en organismos diploides).
Un AA aporta 2 copias del alelo A. Entonces $A=2 \times 25$

Un Aa aporta 1 copia de A y 1 de a. Entonces $A=1 \times 13$

Un aa aporta 0 copias de A. Entonces $A=0 \times 2$

En **Metropolis-Hastings**:

Si $\alpha \geq 1$, acept√°s siempre.
Si $\alpha < 1$, acept√°s con probabilidad $\alpha$. 

Si $u < \alpha$, acept√°s.
Si $u \geq \alpha$, rechaz√°s.

En este caso, $\alpha$ compara qu√© tan probable es observar los datos con la frecuencia propuesta $p'$ respecto de la frecuencia actual $p$. Si $\alpha$ es grande ($\geq 1$), significa que $p'$ explica igual o mejor los datos y se acepta siempre. Si $\alpha < 1$, se acepta con probabilidad proporcional a esa raz√≥n de verosimilitudes.

```{r}
p1 <- 0.8 # La frecuencia actual
p2 <- runif(1)
p2 # La frecuencia propuesta

# Verosimilitud bajo p1
conteo_p1 <- dbinom(63, 100, p1)
conteo_p1
# Verosimilitud bajo p2
conteo_p2 <- dbinom(63, 100, p2)
conteo_p2


# Raz√≥n de verosimilitudes (alpha)
alpha = conteo_p2/conteo_p1
alpha

# Decisi√≥n de aceptar o rechazar
u <- runif(1)
if (u < alpha) {
  decision <- "ACEPTAR"
} else {
  decision <- "RECHAZAR"
}
decision

```


b) Decidir si mover un genotipo

Este es el **Paso 2 del algoritmo MCMC**, donde se decide la reasignaci√≥n de un individuo.

Genotipo considerado: Aa.

Subpoblaciones involucradas: De la **subpoblaci√≥n 1 y 2**.

Frecuencias al√©licas a usar:  $P_{1m‚àí1}‚Äã=0.5$ y $P_{2m‚àí1}‚Äã=0.8$.

C√°lculo de la Probabilidad de Pertenencia

El algoritmo compara la probabilidad del genotipo Aa en cada subpoblaci√≥n, dada la frecuencia de alelos de cada una:

Probabilidad en **Subpoblaci√≥n 1**: $Pr(Aa‚à£Subpop 1)=2‚ãÖP1‚Äã‚ãÖ(1‚àíP1‚Äã)=2‚ãÖ0.5‚ãÖ(1‚àí0.5)=0.5$

Probabilidad en **Subpoblaci√≥n 2**: $Pr(Aa‚à£Subpop 2)=2‚ãÖP2‚Äã‚ãÖ(1‚àíP2‚Äã)=2‚ãÖ0.8‚ãÖ(1‚àí0.8)=2‚ãÖ0.8‚ãÖ0.2=0.32$.

El algoritmo no solo mueve el genotipo a la subpoblaci√≥n m√°s probable. Utiliza la misma regla de Metropolis-Hastings para decidir si aceptar o rechazar el movimiento.

Razon de verosimilitud

$\alpha= \frac{L(\text{genotipo¬†en¬†subpop¬†2})}{L(\text{Genotipo¬†en¬†subpop 1})}$
$‚Äã\alpha=\frac{0.32}{0.50}‚Äã=0.64$.

En este ejemplo, $\alpha = 0.64$ significa que el genotipo Aa tiene un 64% de la probabilidad en la subpoblaci√≥n 2 respecto de la subpoblaci√≥n 1.
Dicho de otra forma: la propuesta es menos consistente con los datos que el estado actual, pero no se descarta de inmediato: el algoritmo le da un 64% de chance de ser aceptada para permitir que la cadena explore tambi√©n valores menos probables (evitando quedarse atrapada en un √∫nico modo).

Regla de Decisi√≥n **Metropolis-Hastings**:

Si $\alpha \geq 1$, acept√°s siempre.
Si $\alpha < 1$, acept√°s con probabilidad $\alpha$. 

Si $u < \alpha$, acept√°s.
Si $u \geq \alpha$, rechaz√°s.

```{r}
# Probabilidad de observar un genotipo Aa en cada subpoblaci√≥n
sub1H <- 2*0.5*(1-0.5)  # Subpoblaci√≥n 1 (p = 0.5)
sub2H <- 2*0.8*(1-0.8)  # Subpoblaci√≥n 2 (p = 0.8)

# Raz√≥n de verosimilitudes (alpha)
alpha <- sub2H / sub1H
alpha

# Decisi√≥n con Metropolis-Hastings
u <- runif(1)
if (u < alpha) {
  decision <- "ACEPTAR"
} else {
  decision <- "RECHAZAR"
}
decision

```
