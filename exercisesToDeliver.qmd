---
title: "P1"
date: today
date-format: "DD MMMM, YYYY"
author: 
  Mathias
abstract:
    Genetica de poblaciones
abstractspacing: double
appendix: false
fontfamily: libertine
monofont: inconsolata
monofontoptions: scaled=.95
fontsize: 12pt
geometry: 
  - top=2cm
  - bottom=2cm
  - left=2cm
  - right=2cm
urlcolor: darkblue
highlight-style: arrow
format: 
    pdf:
      toc: true
      number-sections: true
      colorlinks: true
---


# Ejercicio 3: Coalescente con n=3


3. Consideremos una muestra de $n=3$ alelos para un locus diploide autosómico en una población de tamaño constante ($N = 10^5$), demografía Wright-Fisher y variación genética estrictamente neutra, con tasa de mutación neutra $\mu = 10^{-5}$.


a. ¿Cuál es la esperanza de la antigüedad del ancestro común más cercano ($T_{MRCA}$) a los 3 alelos?
b. ¿Cuál es el número esperado de sitios segregantes (polimorficos) en la muestra?
c. Usar simulaciones para obtener:
   i. Una muestra aleatoria de 50 realizaciones de $T_{MRCA}$. Compararlas con la esperanza obtenida más arriba.
   ii. Una muestra de 50 realizaciones al azar de S para una genealogía con $T_2$ y $T_3$ iguales a sus respectivas esperanzas.

Para $n=3$ existe una unica forma de topologia posible. En este caso, dos linajes de los tres coalescen primero, y el tercer linaje se une a estos coalesciendo mas atras en el tiempo. Las particion formada es $(1,2)$, que es equivalente a $(2,1)$ ya que el orden de los grupos no importa. Esto parte $P(n_1, n_2) = \begin{cases} \frac{1}{n-1} & \text{si } n_1 = n_2 \\ \frac{2}{n-1} & \text{si } n_1 \neq n_2\end{cases}$, asi que $P(1,2) = 2/(3-1) = 1$. La probabilidades asociadas a observar esta particion es 1, de esta manera no hay otra topologia posible.

a. ¿Cuál es la esperanza de la antigüedad del ancestro común más cercano ($T_{MRCA}$) a los 3 alelos?

La esperanza de $T_i$ está dada por el inverso de la $P(coalescencia | n = i)$ por una muestra del tamaño $i$, donde la $P(coalescencia | n = i) = \binom{i}{2} \frac{1}{2N} = \frac{i(i-1)}{4N}$, entonces la esperanza para un $T_i$ es $\mathbb{E}(T_i)= \frac{1}{P(coalescencia | n = i)} = \frac{1}{\binom{i}{2} \frac{1}{2N}} = \frac{4N}{i(i-1)}$

Para $n=3$ alelos tenemos dos coalescencias $T_3$ (de 3 a 2 linajes) y $T_2$ (de 2 a 1 linaje) entonces la esperanza de $T_{MRCA}$ es $\mathbb{E}[T_{MRCA}] = \mathbb{E}[T_3] + \mathbb{E}[T_2] = \frac{4N}{3(3-1)} + \frac{4N}{2(2-1)} = 8/3 N$

Sustituyendo con $N = 10^5$

$\mathbb{E}[T_{MRCA}] = \frac{8}{3} \times 10^5 \simeq 2.67 \times 10^5$ generaciones.

b. ¿Cuál es el número esperado de sitios segregantes (polimorficos) en la muestra?

El numero esperado de sitios segregantes en una muestra esta dado por $\mathbb{E}(S) = T_{total} \cdot \mu$

siendo que el el tiempo total (suma de las longitudes de todas las ramas del coalescente) es $\mathbb{E}[T_{total}]=4N \sum_{i=1}^{n-1} \frac{1}{i}$

Entonces el numero esperado de sitios segregantes se puede estimar $\mathbb{E}[S]=4N \mu \sum_{i=1}^{n-1} \frac{1}{i}$

Sustituyendo con $\mu = 10^{-5}$ y $N = 10^5$

$\mathbb{E}[S]=4 \times 10^5 \times 10^{-5} \times (\frac{1}{1} + \frac{1}{2}) = 6$ es el número esperado de sitios segregantes.

c. Usar simulaciones para obtener:
   i. Una muestra aleatoria de 50 realizaciones de $T_{MRCA}$. Compararlas con la esperanza obtenida más arriba.
   ii. Una muestra de 50 realizaciones al azar de S para una genealogía con $T_2$ y $T_3$ iguales a sus respectivas esperanzas.

```{r}

N <- 1e5
n <- 3

# probabilidad de exito
p3 <- 6/(4*N)
p2 <- 2/(4*N)

# Esperanzas para cada T
E_T3 <- 1 / p3
E_T2 <- 1 / p2
E_TMRCA <- E_T3 + E_T2

# i. Simulaciones de T_MRCA
set.seed(123)  # asegurando que los números sea siempre los mismos
T3 <- rgeom(50, prob = p3)
T2 <- rgeom(50, prob = p2)
T_MRCA <- T3 + T2

cat("Esperanza teorica de T_MRCA =", E_TMRCA, " y la esperanza simulada T_MRCA =", mean(T_MRCA), "\n")

# Comparar con la esperanza teorica
hist(T_MRCA,
     main = "Distribucion simulada de T_MRCA",
     xlab = "Tiempo",
     col = "lightblue", border = "white")
abline(v = E_TMRCA, col = "red", lwd = 2, lty = 1)
legend("topright", legend = c("Esperanza teorica"), col = "red", lty = 1)

```

Imaginemos que empezamos con $n=4$ linajes.
El proceso coalescente consiste en ver cuánto tardan en irse uniendo hasta llegar a un ancestro común.

La probabilidad de coalescencia por generación depende de:

El número de pares posibles: $\binom{n}{2}=\frac{n!}{2!(n-2)!}=n(n−1)/2$
Y de $1/(2N)$, que es la probabilidad de que un par coalesca en una generación.
El tiempo de espera hasta el evento coalescente es el inverso de esa probabilidad.

- De 4 a 3 linajes:
    Pares posibles: $C(4,2)=6$ usando el coficiente binomial $\binom{4}{2} = \frac{4!}{2!(4-2)!}$
    Probabilidad por generación: $\binom{4}{2}.\frac{1}{2N} = 6/(2N)$
    Tiempo esperado: $E[T_4]=2N/6=10^6/6≈1.67×10^5$

- De 3 a 2 linajes:
    Pares posibles: $C(3,2)=3$ usando el coficiente binomial $\binom{3}{2} = \frac{3!}{2!(3-2)!}$
    Probabilidad por generación: $\binom{3}{2}.\frac{1}{2N} = 3/(2N)$
    Tiempo esperado: $E[T_3]=2N/3≈3.33×10^5$

- De 2 a 1 linajes (MRCA):
    Pares posibles: $C(2,2)=1$ usando el coficiente binomial $\binom{2}{2} = \frac{2!}{2!(2-2)!}$
    Probabilidad por generación: $\binom{2}{2}.\frac{1}{2N} = 1/(2N)$
    Tiempo esperado:  $E[T_2]=2N=10^6$

Entonces los tiempos de espera esperados son:

$T_4≈1.67×10^5$

$T_3≈3.33×10^5$

$T_2=10^6$

3. Tiempo total de ramas del árbol

Cada intervalo de tiempo tiene un cierto número de linajes que lo “recorren”: $Ttotal=(n_1⋅T_4)+(n_2⋅T_3)+(n_3⋅T_2)$

- Con 4 linajes durante $T_4$ : $4 \cdot 1.67 \times 10^5≈6.68 \times 10^5$

- Con 3 linajes durante $T_3$ : $3 \cdot 3.33 \times 10^5≈9.99 \times 10^5$

- Con 2 linajes durante $T_2$ : $2 \cdot 10^6=2 \times 10^6$

Sumando: $Ttotal≈3.67 \times 10^6$

4. Número de sitios segregantes $(S)$

El número de sitios segregantes es simplemente: $S=Ttotal \cdot \mu$ 

$S≈(3.67 \times 10^6) \cdot (10^−5)≈36.7$ mutaciones (sitios segregantes)

5. Cálculo de $\pi$ (diversidad nucleotídica promedio por par)

$\pi$ mide las diferencias promedio entre pares de secuencias.

En el coalescente, la esperanza de $\pi$ es: $\pi =4N\mu$

Con nuestros valores: $\pi=4⋅(5 \times 10^5)⋅10^−5=20$

En la práctica, $\pi$ dependerá de cómo se reparten las 37 mutaciones (sitios segregantes) en el árbol, pero el valor esperado es $\pi ≈ 20$.

Si muchas mutaciones cayeron en ramas profundas (compartidas por muchos individuos), eso hará que muchos pares de secuencias difieran en esas posiciones $\pi$ será grande. Si la mayoría de las mutaciones cayeron en ramas terminales (propias de un solo individuo), entonces solo unos pocos pares mostrarán esas diferencias $\pi$ será más chico.

6. Cálculo de $\theta_W$ (Theta de Watterson)

Se define como: $\theta_W = \frac{S}{a_n}$ donde $a_n = \sum_{i=1}^{n-1}1/i$ entonces $\theta_W = \frac{S}{\sum_{i=1}^{n-1}1/i}$

Para $n=4$: $a_4=1+1/2+1/3≈1.833$

Entonces: $\theta_W=37/1.833≈20.18$

Resultado final

$S=37$

$\pi≈20$

$\theta_W≈20.18$

```{r}

# -----------------------------
# Parámetros
# -----------------------------
N <- 5e5        # tamaño efectivo
mu <- 1e-5      # tasa de mutación
n <- 4          # número de secuencias

# -----------------------------
# 1. Simular tiempos de coalescencia
# -----------------------------
# Función para simular tiempo de espera (geométrico)
simular_T <- function(n_linajes, N) {
  pares <- choose(n_linajes, 2)
  p <- pares / (2 * N)     # probabilidad de coalescencia por generación
  rgeom(1, p)              # tiempo de espera ~ geométrica
}

# Guardamos los tiempos
T4 <- simular_T(4, N)
T3 <- simular_T(3, N)
T2 <- simular_T(2, N)

cat("T4 =", T4, "\n")
cat("T3 =", T3, "\n")
cat("T2 =", T2, "\n")

# -----------------------------
# 2. Tiempo total de ramas
# -----------------------------
T_total <- (4 * T4) + (3 * T3) + (2 * T2)
cat("Tiempo total de ramas =", T_total, "\n")

# -----------------------------
# 3. Número de mutaciones (S)
# -----------------------------
S <- rpois(1, lambda = T_total * mu)  # Poisson con media T_total * mu
cat("Número de mutaciones S =", S, "\n")

# -----------------------------
# 4. Diversidad nucleotídica (π)
# -----------------------------
pi_est <- 4 * N * mu
cat("π esperado =", pi_est, "\n")

# -----------------------------
# 5. Theta de Watterson (θW)
# -----------------------------
a_n <- sum(1 / (1:(n - 1)))
theta_W <- S / a_n
cat("θW estimado =", theta_W, "\n")


```
