---
title: "P1"
date: today
date-format: "DD MMMM, YYYY"
author: 
  Mathias
abstract:
    Genetica de poblaciones
abstractspacing: double
appendix: false
fontfamily: libertine
monofont: inconsolata
monofontoptions: scaled=.95
fontsize: 12pt
geometry: 
  - top=2cm
  - bottom=2cm
  - left=2cm
  - right=2cm
urlcolor: darkblue
highlight-style: arrow
format: 
    pdf:
      toc: true
      number-sections: true
      colorlinks: true
---

# Ejercicio 2: Espectro de Frecuencia de Sitios (SFS)

2. Espectro de Frequencia de Sitios (SFS: site frequency spectrum): 
a. explicar que es el SFS y cuales son las esperanzas bajo el modelo neutral estandar. 
b. Mostrar como se obtienen las esperanzas para muestras de alelos de tamano n=2 y n=3.

## a. explicar que es el SFS y cuales son las esperanzas bajo el modelo neutral estándar.

El Site Frequency Spectrum (SFS) es una distribución de frecuencias que resume la variabilidad genética observada en una población o muestra. En particular, SFS muestra cuantos sitios segregantes presentan el alelo derivado en $1, 2, 3...$ hasta $n-1$  copias dentro de una muestra de tamaño $n$. De esta manera, el SFS describe la frecuencia de las mutaciones según cuantas copias derivadas tienen, lo que permite estudiar procesos evolutivos como es la deriva y la selección.

La esperanza bajo el modelo neutral estándar se define como 

$\mathbb{E}[S_i] = \theta \cdot \frac{1}{i} = 4N \mu \cdot \frac{1}{i}$

donde $4N\mu$ diversidad genética, combina tamaño poblacional efectivo $(N)$ y la tasa de mutación por sitios $(\mu)$
$\frac{1}{i}$ factor del tiempo esperado en un momento que hay $i$ linajes en la genealogía.

## b. Mostrar como se obtienen las esperanzas para muestras de alelos de tamano n=2 y n=3.

Para $n=2$ solo hay $n-1 = 1$, siendo $i = 1$ 

$\mathbb{E}[S_2​]= \theta \cdot \frac{1}{1} = 4N \mu$

Para $n=3$ hay $n-1 = 2$, hay $i=1$ y $i=2$

$\mathbb{E}[S] = \mathbb{E}[S_1] + \mathbb{E}[S_2] = \theta \cdot \frac{1}{1} + \theta \cdot \frac{1}{2}$

$\mathbb{E}[S] = \frac{3}{2} \cdot \theta = \frac{3}{2} \cdot 4N \mu$


# Ejercicio 3: Coalescente con n=3

3. Consideremos una muestra de $n=3$ alelos para un locus diploide autosómico en una población de tamaño constante ($N = 10^5$), demografía Wright-Fisher y variación genética estrictamente neutra, con tasa de mutación neutra $\mu = 10^{-5}$.


a. ¿Cuál es la esperanza de la antigüedad del ancestro común más cercano ($T_{MRCA}$) a los 3 alelos?
b. ¿Cuál es el número esperado de sitios segregantes (polimorficos) en la muestra?
c. Usar simulaciones para obtener:
   i. Una muestra aleatoria de 50 realizaciones de $T_{MRCA}$. Compararlas con la esperanza obtenida más arriba.
   ii. Una muestra de 50 realizaciones al azar de S para una genealogía con $T_2$ y $T_3$ iguales a sus respectivas esperanzas.

## a. ¿Cuál es la esperanza de la antigüedad del ancestro común más cercano ($T_{MRCA}$) a los 3 alelos?

La esperanza de $T_i$ está dada por el inverso de la $P(coalescencia | n = i)$ por una muestra del tamaño $i$, donde la 

$P(coalescencia | n = i) = \binom{i}{2} \frac{1}{2N} = \frac{i(i-1)}{4N}$, 

entonces la esperanza es 3

$T_i$ es $\mathbb{E}(T_i)= \frac{1}{P(coalescencia | n = i)} = \frac{1}{\binom{i}{2} \frac{1}{2N}} = \frac{4N}{i(i-1)}$

Para $n=3$ alelos tenemos dos coalescencias $T_3$ (de 3 a 2 linajes) y $T_2$ (de 2 a 1 linaje) entonces la esperanza de $T_{MRCA}$ es: 

$\mathbb{E}[T_{MRCA}] = \mathbb{E}[T_3] + \mathbb{E}[T_2] = \frac{4N}{3(3-1)} + \frac{4N}{2(2-1)} = 8/3 N$

Sustituyendo con $N = 10^5$

$\mathbb{E}[T_{MRCA}] = \frac{8}{3} \times 10^5 \simeq 2.67 \times 10^5$ 

Se espera que los $n=3$ alelos compartan un ancestro común hace aproximadamente $2.67 \times 10^5$ generaciones.

## b. ¿Cuál es el número esperado de sitios segregantes (polimorficos) en la muestra?

El numero esperado de sitios segregantes en una muestra esta dado por 

$\mathbb{E}(S) = T_{total} \cdot \mu$

siendo que el el tiempo total (suma de las longitudes de todas las ramas del coalescente) es 

$\mathbb{E}[T_{total}]=4N \sum_{i=1}^{n-1} \frac{1}{i}$

Entonces el numero esperado de sitios segregantes se puede estimar $\mathbb{E}[S]=4N \mu \sum_{i=1}^{n-1} \frac{1}{i}$

Sustituyendo con $\mu = 10^{-5}$ y $N = 10^5$

$\mathbb{E}[S]=4 \times 10^5 \times 10^{-5} \times (\frac{1}{1} + \frac{1}{2}) = 6$ 

Siendo $6$ el número esperado de sitios segregantes.

## c. Usar simulaciones para obtener:
   i. Una muestra aleatoria de 50 realizaciones de $T_{MRCA}$. Compararlas con la esperanza obtenida más arriba.
   ii. Una muestra de 50 realizaciones al azar de S para una genealogía con $T_2$ y $T_3$ iguales a sus respectivas esperanzas.

```{r}

N <- 1e5

# probabilidad de exito
p3 <- 6/(4*N)
p2 <- 2/(4*N)

# Esperanzas para cada T
E_T3 <- 1 / p3
E_T2 <- 1 / p2
E_TMRCA <- E_T3 + E_T2

# Simulaciones de T_MRCA
set.seed(123)  # asegurando que los números sea siempre los mismos
T3 <- rgeom(50, prob = p3)
T2 <- rgeom(50, prob = p2)
T_MRCA <- T3 + T2

cat("Esperanza teorica de T_MRCA =", E_TMRCA, " y la esperanza simulada T_MRCA =", mean(T_MRCA), "\n")

hist(T_MRCA,
     main = "Distribucion simulada de T_MRCA",
     xlab = "Tiempo hasta coalescencia",
     col = "lightblue", border = "white")
abline(v = E_TMRCA, col = "red", lwd = 2, lty = 1)
legend("topright", legend = c("Esperanza teorica"), col = "red", lty = 1)

```

La esperanza media simulada es ligeramente mayor que la esperanza teorica, esto se puede explicar por la gran varianza que tiene la distribución geométrica y tambien al tamaño moderado de la muestra (50 simulaciones). Por la ley de los Grandes Números, a medida que el número de realizaciones en tu muestra (n=50) aumenta, la media de esa muestra $(\bar{X})$ converge al valor de la esperanza teórica $(\mathbb{E}[X])$. Finalmente, la mayor densidad de los resultados se agrupa alrededor de la esperanza teorica (linea roja).

```{r}
# número de sitios segregantes
nS <- 6 # Ttotal * mu

# Simular 50 realizaciones de S
set.seed(321) # asegurando que los números sea siempre los mismos
S_sim <- rpois(50, nS)

# media de simular S
mean_S <- mean(S_sim)

# plot simple
hist(S_sim, main = "Simulación de S (50 rep.)", xlab = "Número de sitios segregantes (S)",
     col = "lightgreen", border = "white")
abline(v = nS, col = "red", lwd = 2, lty = 1)
legend("topright", legend = paste("E[S] teórico =", round(nS,2)), col = "red", lty = 1)

```

# Ejercicio 4: Simulación de coalescente con n=2

4. Considerando ahora muestras de pares de alelos $(n=2)$ para el mismo sistema genético, usar simulaciones para obtener:

a. Una muestra de 50 realizaciones de $T_2$.
b. Una muestra de 50 realizaciones de $S$ combinando la variación al azar de la genealogía con mutaciones al azar.

## a. Una muestra de 50 realizaciones de $T_2$.

```{r}

N <- 1e5

# Probabilidad de coalescencia
p2 <- 2/(4*N)

# Esperanzas para T
E_T2 <- 1 / p2

# Simulaciones de T2
set.seed(3)  # asegurando que los números sea siempre los mismos
T2 <- rgeom(50, prob = p2)

# Plot distribucion de T2
hist(T2,
     breaks = 15,
     main = "Distribucion simulada de T2",
     xlab = "Tiempo hasta coalescencia (T2)",
     col = "lightblue", border = "white")
abline(v = E_T2, col = "red", lwd = 2, lty = 1)
legend("topright", legend = c("Esperanza teórica"), col = "red", lty = 1, lwd = 2)

```

## b. Una muestra de 50 realizaciones de $S$ combinando la variación al azar de la genealogía con mutaciones al azar.

```{r}

# Para cada T2 simulado, el árbol tiene 2 ramas => T_total = 2 * T2
T_total <- 2 * T2
lambda <- 1e-5 * T_total

# Simular S para cada genealogía (Poisson)
S <- rpois(50, lambda = lambda)

# Resumen de S
cat("\nSimulaciones de S:\n")
cat("Media simulada S =", mean(S), "  (sd =", sd(S), ")\n")

hist(S,
     breaks = 15,
     main = "Distribución de S (variación de genealogía + mutaciones)",
     xlab = "Número de sitios segregantes (S)",
     col = "lightgreen", border = "white")
abline(v = mean(S), col = "darkgreen", lwd = 2)
legend("topright", legend = c("Media simulada de S"),
       col = "darkgreen", lty = 1)

```

